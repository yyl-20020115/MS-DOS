

;
; +-------------------------------------------------------------------------+
; |   This file has been generated by The Interactive Disassembler (IDA)    |
; |           Copyright (c) 2017 Hex-Rays, <support@hex-rays.com>           |
; |                      License info: 48-3FBD-7F04-2C                      |
; |                      Jiang Ying, Personal license                       |
; +-------------------------------------------------------------------------+
;
; Input SHA256 : 2AD14B49A9206E47A6942C9E2BC738C00D804D34CB8D693312228CF49820E508
; Input MD5    : 3AE9522BF6F32FB95790906063E94F41
; Input CRC32  : 0DDA7943

; File Name   : D:\Working\MS-DOS\v1.25\bin\EXE-SRC\SETCLOCK.COM
; Format      : MS-DOS COM-file
; Base Address: 1000h Range: 10100h-10455h Loaded length: 355h

                .8086
                ;.model tiny

; ===========================================================================

; Segment type: Pure code
seg000          segment byte public 'CODE'
                assume cs:seg000
                org 100h
                assume es:nothing, ss:nothing, ds:seg000
start:                                  ; ENTRY POINT: start
                jmp real_start                        ; CODE XREF: main↑j
; [00000003 BYTES: COLLAPSED FUNCTION start. PRESS CTRL-NUMPAD+ TO EXPAND]
dword_10103     dd 0                    ; DATA XREF: seg000:0441↓w
                                        ; seg000:044B↓w
                db '€'
                db 0FCh
                db  2Bh ; +
                db  73h ; s
                db    5
                db  2Eh ; .
                db 0FFh
                db  2Eh ; .
                db    3
                db    1
                db  74h ; t
                db    5
                db  80h ; €
                db 0FCh
                db  2Dh ; -
                db  75h ; u
                db 0F4h
                db  50h ; P
                db  2Eh ; .
                db 0FFh
                db  36h ; 6
                db 0FEh
                db    0
                db  2Eh ; .
                db 0FFh
                db  1Eh
                db    3
                db    1
                db  3Ch ; <
                db 0FFh
                db  75h ; u
                db    4
                db  83h
                db 0C4h
                db    2
                db 0CFh
                db  58h ; X
                db  53h ; S
                db  51h ; Q
                db  52h ; R
                db  55h ; U
                db  56h ; V
                db  8Bh
                db 0F1h
                db 0BDh
                db 0C0h
                db    2
                db  52h ; R
                db  8Dh
                db  56h ; V
                db    1
                db 0B1h
                db    1
                db  80h ; €
                db 0FCh
                db  2Dh ; -
                db  74h ; t
                db  13h
                db  8Dh
                db  56h ; V
                db  0Ah
                db  96h
                db  2Dh ; -
                db 0BCh
                db    7
                db 0EEh
                db  58h ; X
                db  50h ; P
                db  8Ah
                db 0C4h
                db  4Ah ; J
                db 0EEh
                db  8Dh
                db  56h ; V
                db    6
                db  2Bh ; +
                db 0C9h
                db  58h ; X
                db  50h ; P
                db 0E8h
                db  28h ; (
                db    0
                db 0EEh
                db  42h ; B
                db  58h ; X
                db  8Ah
                db 0C4h
                db 0E8h
                db  20h
                db    0
                db 0EEh
                db 0E3h
                db    6
                db  42h ; B
                db  2Bh ; +
                db 0C9h
                db  56h ; V
                db 0EBh
                db 0EAh
                db  5Eh ; ^
                db  5Dh ; ]
                db  5Ah ; Z
                db  59h ; Y
                db  5Bh ; [
                db  2Bh ; +
                db 0C0h
                db 0CFh

; =============== S U B R O U T I N E =======================================


sub_10172       proc near               ; CODE XREF: seg000:0181↓p
                                        ; sub_101AD+5↓p
                mov     bh, 0Ah
                sub     ah, ah
                cmp     al, 63h
                jbe     short loc_1017C
                mov     al, 63h

loc_1017C:                              ; CODE XREF: sub_10172+6↑j
                div     bh
                xchg    al, ah
                ret
sub_10172       endp

; ---------------------------------------------------------------------------
                call    sub_10172
                shl     ah, 1
                shl     ah, 1
                shl     ah, 1
                shl     ah, 1
                or      al, ah
                ret
; ---------------------------------------------------------------------------
                db    0
                db    0
                db    0
                db    0
                db    0
                db    0
                db    0
                db    0
                db    0
                db    0

; =============== S U B R O U T I N E =======================================


sub_10199       proc near               ; CODE XREF: seg000:0396↓p
                                        ; seg000:03CE↓p ...
                mov     si, 18Fh
                mov     di, si
                cld
                lea     dx, [bp+1]
                ret
sub_10199       endp


; =============== S U B R O U T I N E =======================================


sub_101A3       proc near               ; CODE XREF: seg000:03D1↓p
                                        ; seg000:03D9↓p
                lodsw
                xchg    ax, dx
                lodsw
                xchg    ax, cx
                ret
sub_101A3       endp


; =============== S U B R O U T I N E =======================================


sub_101A8       proc near               ; CODE XREF: seg000:0375↓p
                                        ; seg000:0423↓p ...
                mov     ah, 9
                int     21h             ; DOS - PRINT STRING
                                        ; DS:DX -> string terminated by "$"
                ret
sub_101A8       endp


; =============== S U B R O U T I N E =======================================


sub_101AD       proc near               ; CODE XREF: seg000:03F2↓p
                                        ; seg000:0410↓p
                xchg    ax, bx
                mov     cx, 4

loc_101B1:                              ; CODE XREF: sub_101AD+1A↓j
                lodsb
                call    sub_10172
                add     ax, 3030h
                xchg    al, ah
                call    loc_101CD
                xchg    al, ah
                call    loc_101CD
                mov     al, bl
                call    loc_101CD
                loop    loc_101B1
                mov     ax, 0A0Dh
                ret
sub_101AD       endp

; ---------------------------------------------------------------------------

loc_101CD:                              ; CODE XREF: sub_101AD+D↑p
                                        ; sub_101AD+12↑p ...
                mov     [di], al
                inc     di
                ret
; ---------------------------------------------------------------------------
aAstResearchInc db 'AST RESEARCH, INC. REAL TIME CLOCK INTERFACE PROGRAM for the IBM '
                db 'PERSONAL COMPUTER. (C)Copyright AST RESEARCH, INC., 1982. License'
                db 'd material - program property of AST RESEARCH, INC. author - DARY'
                db 'L WATTONCurrent time is 00:00:00.00 ',0Dh,0Ah,'$'
aCurrentDateIs0 db 'Current date is 00/00/80/00',0Dh,0Ah,'$'
aRealTimeClockM db 'Real-time clock module is already resident...',0Dh,0Ah
                db '   duplicate request ignored.',0Dh,0Ah,'$'
aResidentDateTi db 0Dh,0Ah
                db ' resident DATE/TIME processors loaded',0Dh,0Ah
                db 0Dh,0Ah,'$'
; ---------------------------------------------------------------------------

real_start:                             ; CODE XREF: start↑j
                mov     bp, 2C0h
                mov     sp, 100h
                mov     si, 107h
                mov     di, si
                sub     ax, ax
                push    es
                mov     es, ax
                assume es:nothing
                mov     ax, es:86h
                mov     es, ax
                assume es:nothing
                mov     cx, 63h
                repe cmpsb
                pop     es
                jnz     short loc_1037B
                mov     dx, 2D9h
                call    sub_101A8
                ;should be start-100H
                jmp     start
; ---------------------------------------------------------------------------

loc_1037B:                              ; CODE XREF: seg000:0370↑j
                lea     dx, [bp+0Bh]
                in      al, dx
                cmp     al, 0DEh
                jz      short loc_10390
                mov     al, 0FFh
                push    dx
                lea     dx, [bp+12h]
                out     dx, al
                inc     dx
                out     dx, al
                pop     dx
                mov     al, 0DEh
                out     dx, al

loc_10390:                              ; CODE XREF: seg000:0381↑j
                mov     cx, 8

loc_10393:                              ; CODE XREF: seg000:03B6↓j
                push    cx
                mov     cl, 7
                call    sub_10199

loc_10399:                              ; CODE XREF: seg000:03AD↓j
                in      al, dx
                inc     dx
                push    ax
                push    cx
                mov     cl, 4
                shr     al, cl
                pop     cx
                pop     bx
                mov     bh, 0Ah
                mul     bh
                and     bl, 0Fh
                add     al, bl
                stosb
                loop    loc_10399
                lea     dx, [bp+14h]
                in      al, dx
                test    al, al
                pop     cx
                loopne  loc_10393
                sub     bx, bx
                lea     dx, [bp+9]
                in      al, dx
                cmp     al, [di-1]
                jbe     short loc_103C4
                inc     bx

loc_103C4:                              ; CODE XREF: seg000:03C1↑j
                mov     al, [di-1]
                out     dx, al
                inc     dx
                in      al, dx
                add     al, bl
                out     dx, al
                stosw
                call    sub_10199
                call    sub_101A3
                mov     ah, 2Dh
                int     21h             ; DOS - SET CURRENT TIME
                                        ; CH = hours, CL = minutes, DH = seconds, DL = hundredths of seconds
                                        ; Return: AL = 00h if no error / = FFh if bad value sent to routine
                inc     si
                call    sub_101A3
                sub     ch, ch
                add     cx, 7BCh
                mov     ah, 2Bh
                int     21h             ; DOS - SET CURRENT DATE
                                        ; DL = day, DH = month, CX = year
                                        ; Return: AL = 00h if no error /= FFh if bad value sent to routine
                call    sub_10199
                mov     al, 3Ah
                mov     di, 2ACh
                add     si, 3
                std
                call    sub_101AD
                mov     byte ptr [di-1], 20h
                mov     si, 194h
                cld
                mov     ax, [si]
                xchg    al, ah
                mov     [si], ax
                mov     al, [si+2]
                add     al, 50h
                mov     [si+2], al
                mov     al, 2Fh
                mov     di, 2CBh
                call    sub_101AD
                mov     word ptr aCurrentDateIs0+18h, ax ; "/00\r\n$"
                mov     byte ptr aCurrentDateIs0+1Ah, 24h ; "0\r\n$"
                mov     byte ptr aAstResearchInc+0E3h, 2Eh ; ".00 \r\n$"
                mov     dx, 328h
                call    sub_101A8
                mov     dx, 2BBh
                call    sub_101A8
                mov     dx, 29Ch
                call    sub_101A8
                sub     ax, ax
                mov     ds:0FEh, ax
                mov     es, ax
                assume es:nothing
                mov     ax, 107h
                xchg    ax, es:84h
                mov     word ptr dword_10103, ax
                mov     ax, cs
                xchg    ax, es:86h
                mov     word ptr dword_10103+2, ax
                push    ds
                pop     es
                assume es:seg000
                mov     dx, 18Fh
                int     27h             ; DOS - TERMINATE BUT STAY RESIDENT
seg000          ends                    ; CS = current program segment
                                        ; DX = last program byte + 1

                end start
