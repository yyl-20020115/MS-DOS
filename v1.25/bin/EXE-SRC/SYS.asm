

;
; +-------------------------------------------------------------------------+
; |   This file has been generated by The Interactive Disassembler (IDA)    |
; |           Copyright (c) 2017 Hex-Rays, <support@hex-rays.com>           |
; |                      License info: 48-3FBD-7F04-2C                      |
; |                      Jiang Ying, Personal license                       |
; +-------------------------------------------------------------------------+
;
; Input SHA256 : EAF5E7DBD3EDBEF716765FFB0A7554351061A6E80AF5AE4CEC5707D76CB7D7E1
; Input MD5    : F4759B60F3A5FB8B8323CED9B2437E5A
; Input CRC32  : 15474B84

; File Name   : D:\Working\MS-DOS\v1.25\bin\EXE-SRC\SYS.COM
; Format      : MS-DOS COM-file
; Base Address: 1000h Range: 10100h-1035Dh Loaded length: 25Dh

                .8086
;               .model tiny

; ===========================================================================

; Segment type: Pure code
seg000          segment byte public 'CODE'
                assume cs:seg000
                org 100h
                assume es:nothing, ss:nothing, ds:seg000

; =============== S U B R O U T I N E =======================================

; Attributes: noreturn

                public start
start           proc near
                jmp     short loc_10124
; ---------------------------------------------------------------------------

loc_10102:                              ; CODE XREF: start+29↓j
                mov     dx, 254h
                jmp     loc_101C9
; ---------------------------------------------------------------------------

loc_10108:                              ; CODE XREF: start+2D↓j
                                        ; start+34↓j ...
                mov     dx, 238h
                jmp     loc_101C9
; ---------------------------------------------------------------------------

loc_1010E:                              ; CODE XREF: start+4E↓j
                                        ; start+59↓j
                mov     al, byte ptr aInvalidDriveSp+0C0h ; ""
                add     al, 40h
                mov     byte ptr aInvalidDriveSp+4Ah, al ; "A\r\nand strike any key when ready\r\n$"...
                mov     dx, 266h
                mov     ah, 9
                int     21h             ; DOS - PRINT STRING
                                        ; DS:DX -> string terminated by "$"
                mov     ax, 0C08h
                int     21h             ; DOS - CLEAR KEYBOARD BUFFER
                                        ; AL must be 01h, 06h, 07h, 08h, or 0Ah.
                xor     al, al

loc_10124:                              ; CODE XREF: start↑j
                cmp     byte ptr ds:5Dh, 20h
                jnz     short loc_10102
                cmp     al, 0FFh
                jz      short loc_10108
                cmp     byte ptr ds:5Ch, 0
                jz      short loc_10108
                mov     ah, 19h
                int     21h             ; DOS - GET DEFAULT DISK NUMBER
                inc     al
                mov     byte ptr aInvalidDriveSp+0C0h, al ; ""
                cmp     ds:5Ch, al
                jz      short loc_10108
                mov     ah, 0Fh
                mov     dx, 2F9h
                int     21h             ; DOS - OPEN DISK FILE
                                        ; DS:DX -> FCB
                                        ; Return: AL = 00h file found, FFh file not found
                or      al, al
                jnz     short loc_1010E
                mov     dx, 32Bh
                mov     ah, 0Fh
                int     21h             ; DOS - OPEN DISK FILE
                                        ; DS:DX -> FCB
                                        ; Return: AL = 00h file found, FFh file not found
                or      al, al
                jnz     short loc_1010E
                mov     ah, 1Ah
                mov     dx, 235Eh
                int     21h             ; DOS - SET DISK TRANSFER AREA ADDRESS
                                        ; DS:DX -> disk transfer buffer
                mov     ax, 1
                mov     word_1030E, ax
                mov     word_10340, ax
                mov     bx, 2F9h
                mov     cx, 8000h
                call    read
                mov     dx, 35Eh
                mov     ah, 1Ah
                int     21h             ; DOS - SET DISK TRANSFER AREA ADDRESS
                                        ; DS:DX -> disk transfer buffer
                mov     bx, 32Bh
                mov     cx, 2000h
                call    read
                mov     al, ds:5Ch
                mov     byte_10332, al
                mov     byte_10300, al
                mov     dl, ds:5Ch
                mov     ah, 1Ch
                int     21h             ; DOS - GET ALLOCATION TABLE INFORMATION FOR SPECIFIC DRIVE
                                        ; DL = drive number to check (0=default, 1=A, etc)
                push    cs
                pop     ds
                mov     ah, 0
                mul     cx
                xchg    ax, cx
                mov     bx, 2F9h
                call    open
                jnz     short loc_101D4
                mov     bx, 32Bh
                call    open
                ja      short loc_101D4
                mov     dx, 235Eh
                mov     ah, 1Ah
                int     21h             ; DOS - SET DISK TRANSFER AREA ADDRESS
                                        ; DS:DX -> disk transfer buffer
                mov     bx, 2F9h
                call    write
                mov     dx, 35Eh
                mov     ah, 1Ah
                int     21h             ; DOS - SET DISK TRANSFER AREA ADDRESS
                                        ; DS:DX -> disk transfer buffer
                mov     bx, 32Bh
                call    write
                mov     dx, 2E5h

loc_101C9:                              ; CODE XREF: start+5↑j
                                        ; start+B↑j ...
                mov     ah, 9
                int     21h             ; DOS - PRINT STRING
                                        ; DS:DX -> string terminated by "$"
                int     20h             ; DOS - PROGRAM TERMINATION
                                        ; returns to DOS--identical to INT 21/AH=00h
; ---------------------------------------------------------------------------

loc_101CF:                              ; CODE XREF: open+8↓j
                mov     dx, 2A5h
                jmp     short loc_101C9
; ---------------------------------------------------------------------------

loc_101D4:                              ; CODE XREF: start+A2↑j
                                        ; start+AA↑j
                mov     dx, 2CCh
                jmp     short loc_101C9
start           endp


; =============== S U B R O U T I N E =======================================


read            proc near               ; CODE XREF: start+71↑p
                                        ; start+81↑p
                mov     ah, 27h
                mov     dx, bx
                int     21h             ; DOS - RANDOM BLOCK READ
                                        ; DS:DX -> FCB
                                        ; CX = number of records to be read
                mov     [bx+30h], cx
                mov     ax, [bx+1Bh]
                mov     [bx+2Ch], ax
                mov     ax, [bx+1Dh]
                mov     [bx+2Eh], ax
                ;retn
                ret
read            endp


; =============== S U B R O U T I N E =======================================


open            proc near               ; CODE XREF: start+9F↑p
                                        ; start+A7↑p
                mov     ah, 0Fh
                mov     dx, bx
                int     21h             ; DOS - OPEN DISK FILE
                                        ; DS:DX -> FCB
                                        ; Return: AL = 00h file found, FFh file not found
                or      al, al
                jnz     short loc_101CF
                mov     ax, [bx+17h]
                xor     dx, dx
                add     ax, cx
                dec     ax
                div     cx
                push    ax
                mov     ax, [bx+30h]
                add     ax, cx
                dec     ax
                xor     dx, dx
                div     cx
                pop     dx
                cmp     ax, dx
                ;retn
                ret
open            endp


; =============== S U B R O U T I N E =======================================


write           proc near               ; CODE XREF: start+B6↑p
                                        ; start+C3↑p
                mov     dx, bx
                xor     ax, ax
                mov     [bx+28h], ax
                mov     [bx+2Ah], ax
                inc     ax
                mov     [bx+15h], ax
                mov     ah, 28h
                mov     cx, [bx+30h]
                int     21h             ; DOS - RANDOM BLOCK WRITE
                                        ; DS:DX -> FCB
                                        ; CX = number of records to be written
                                        ; if zero, truncate file to current random file position
                mov     ax, [bx+2Ch]
                mov     [bx+1Bh], ax
                mov     ax, [bx+2Eh]
                mov     [bx+1Dh], ax
                mov     ah, 10h
                int     21h             ; DOS - CLOSE DISK FILE
                                        ; DS:DX -> FCB
                                        ; Return: AL = 00h directory update successful
                                        ; FFh file not found in directory
                ;retn
                ret
write           endp

; ---------------------------------------------------------------------------
aInvalidDriveSp db 'Invalid drive specification$Invalid parameter$Insert system disk '
                db 'in drive A',0Dh,0Ah
                db 'and strike any key when ready',0Dh,0Ah
                db '$No room for system on destination disk$Incompatible system size$'
                db 'System transferred$',0
                db 0FFh, 5 dup(0), 6
byte_10300      db 0                    ; DATA XREF: start+8A↑w
aIbmbioCom      db 'IBMBIO  COM',0
                ;align 2
word_1030E      dw 0                    ; DATA XREF: start+65↑w
                db 1Ch dup(0), 0FFh, 5 dup(0), 6
byte_10332      db 0                    ; DATA XREF: start+87↑w
aIbmdosCom      db 'IBMDOS  COM',0
                ;align 2
word_10340      dw 0                    ; DATA XREF: start+68↑w
                db 1Ch dup(0)
seg000          ends


                end start
